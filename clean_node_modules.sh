#!/bin/bash

# Check if the path is provided as an argument
if [ -z "$1" ]; then
  echo "Usage: $0 <path>"
  exit 1
fi

TARGET_PATH="$1"
REPORT_FILE="node_modules_deletion_report.txt"

# Prepare the report file
echo "Node Modules Deletion Report" > "$REPORT_FILE"
echo "============================" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"

# Function to delete node_modules and track disk usage
delete_node_modules() {
  local dir="$1"
  local size=$(du -sh "$dir/node_modules" 2>/dev/null | cut -f1)

  if [ -n "$size" ]; then
    rm -rf "$dir/node_modules"
    echo "Deleted: $dir/node_modules" | tee -a "$REPORT_FILE"
    echo "Space Freed: $size" | tee -a "$REPORT_FILE"
    echo "" | tee -a "$REPORT_FILE"
  fi
}

# Export the function to be used by 'find'
export -f delete_node_modules
export REPORT_FILE

# Find all node_modules folders and delete them
find "$TARGET_PATH" -name "node_modules" -type d -prune -exec bash -c 'delete_node_modules "$(dirname "{}")"' \;

echo "Report generated at: $REPORT_FILE"